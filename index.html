<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Санта | Рабочие дни</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background-color: #00a7e0;
      font-family: 'Roboto', Tahoma, sans-serif;
      color: white;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 480px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 25px;
    }
    .header h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 30px;
    }
    .nav_buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
      gap: 10px;
    }
    .nav_btn {
      flex: 1;
      background-color: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      text-decoration: none;
    }
    .nav_btn:hover {
      background-color: rgba(255,255,255,0.3);
    }
    .nav_btn.active {
      background-color: white;
      color: #00a7e0;
    }
    .form_card {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      color: #333;
    }
    .input_group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      color: #555;
      margin-bottom: 8px;
      font-weight: 500;
    }
    input, textarea, select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
      color: #333;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    .time_inputs {
      display: flex;
      gap: 10px;
    }
    .time_inputs input {
      flex: 1;
    }
    .radio_group {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      color: #333;
    }
    .radio_option {
      display: flex;
      align-items: center;
    }
    .radio_option input {
      width: auto;
      margin-right: 8px;
    }
    .file_upload {
      margin: 25px 0;
      position: relative;
    }
    .upload_btn {
      display: block;
      background-color: #f0f0f0;
      color: #555;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      font-size: 16px;
      transition: all 0.3s;
      border: 2px dashed #ccc;
    }
    .upload_btn:hover {
      background-color: #e0e0e0;
      border-color: #aaa;
    }
    .file_input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      cursor: pointer;
    }
    .file_preview {
      margin-top: 15px;
      display: none;
    }
    .file_preview.active {
      display: block;
    }
    .file_item {
      display: flex;
      align-items: center;
      background-color: #f8f8f8;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      color: #333;
    }
    .file_icon {
      margin-right: 10px;
      color: #00a7e0;
      font-size: 20px;
      line-height: 1;
    }
    .file_name {
      flex: 1;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .salary_info {
      margin-bottom: 20px;
      font-weight: 600;
      color: #333;
      font-size: 16px;
      text-align: right;
    }
    .submit_btn {
      background-color: #00a7e0;
      color: white;
      border: none;
      padding: 16px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 500;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .submit_btn:hover {
      background-color: #0088c0;
    }
    
    /* Стили для списка дней */
    .days_list {
      display: none;
    }
    .day_card {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      color: #333;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .day_header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-weight: 500;
    }
    .day_time {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .day_comment {
      margin-bottom: 15px;
      white-space: pre-wrap;
    }
    .day_media {
      margin-top: 15px;
    }
    .media_item {
      display: inline-block;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .delete_btn {
      background-color: #ff4444;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      margin-top: 15px;
    }
    .user_filter {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    .user_filter_btn {
      background-color: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
    }
    .user_filter_btn.active {
      background-color: white;
      color: #00a7e0;
    }
    
    /* Статистика */
    .stats_container {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      color: #333;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .stats_header {
      font-weight: 700;
      margin-bottom: 15px;
      text-align: center;
      font-size: 18px;
    }
    .stats_item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .stats_label {
      font-weight: 500;
    }
    .stats_value {
      font-weight: 600;
    }
    .month_selector {
      margin-bottom: 15px;
    }
    
    @media (max-width: 480px) {
      body {
        padding: 15px;
      }
      .header h1 {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1 id="pageTitle">Добавить рабочий день</h1>
  </div>
  
  <div class="nav_buttons">
    <a href="#" class="nav_btn" id="allDaysBtn">Все дни</a>
    <a href="#" class="nav_btn active" id="newDayBtn">Новый день</a>
    <a href="#" class="nav_btn" id="settingsBtn">Настройки</a>
  </div>
  
  <!-- Форма добавления нового дня -->
  <div class="form_card" id="newDayForm">
    <form id="dayForm">
      <div class="radio_group">
        <div class="radio_option">
          <input type="radio" id="denis" name="user" value="Денис" checked />
          <label for="denis">Денис</label>
        </div>
        <div class="radio_option">
          <input type="radio" id="polina" name="user" value="Полина" />
          <label for="polina">Полина</label>
        </div>
      </div>
      <div class="input_group">
        <label for="date">Дата</label>
        <input type="date" id="date" required />
      </div>
      <div class="input_group">
        <label>Время работы</label>
        <div class="time_inputs">
          <input type="time" id="start_time" value="08:00" required />
          <input type="time" id="end_time" value="20:00" required />
        </div>
      </div>
      <div class="input_group">
        <label for="comment">Комментарий ко дню</label>
        <textarea id="comment" placeholder="Опишите ваш день..."></textarea>
      </div>
      <div class="file_upload">
        <label class="upload_btn" for="media">+ Прикрепить фото/видео</label>
        <input type="file" id="media" class="file_input" accept="image/*,video/*" multiple />
        <div class="file_preview" id="filePreview"></div>
      </div>
      <div class="salary_info" id="salaryInfo">Зарплата: 0.00 руб.</div>
      <button type="submit" class="submit_btn">Сохранить</button>
    </form>
  </div>
  
  <!-- Список всех дней -->
  <div class="days_list" id="daysList">
    <div class="user_filter">
      <button class="user_filter_btn active" data-user="all">Все</button>
      <button class="user_filter_btn" data-user="Денис">Денис</button>
      <button class="user_filter_btn" data-user="Полина">Полина</button>
    </div>
    
    <!-- Блок статистики -->
    <div class="stats_container" id="statsContainer">
      <div class="stats_header">Статистика за <span id="currentMonthYear"></span></div>
      <div class="month_selector">
        <select id="monthSelect">
          <!-- Месяцы будут добавлены через JS -->
        </select>
      </div>
      <div class="stats_item">
        <span class="stats_label">Отработано дней:</span>
        <span class="stats_value" id="daysWorked">0</span>
      </div>
      <div class="stats_item">
        <span class="stats_label">Отработано часов:</span>
        <span class="stats_value" id="hoursWorked">0</span>
      </div>
      <div class="stats_item">
        <span class="stats_label">Зарплата:</span>
        <span class="stats_value" id="totalSalary">0.00 руб.</span>
      </div>
      <div class="stats_item">
        <span class="stats_label">Зарплата в договоре:</span>
        <span class="stats_value" id="contractSalary">0.00 руб.</span>
      </div>
    </div>
    
    <div id="daysContainer">
      <!-- Дни будут добавляться сюда -->
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    deleteDoc,
    doc,
    query,
    where,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCd2Y3GhHKtibLrqipERwf5vMrCSNLFl60",
    authDomain: "santa-diary.firebaseapp.com",
    projectId: "santa-diary",
    storageBucket: "santa-diary.appspot.com",
    messagingSenderId: "193506574944",
    appId: "1:193506574944:web:23e0282d5129f2f793c7a7",
    measurementId: "G-GTPJ66CWH0"
  };
  const app = initializeApp(firebaseConfig);
  getAnalytics(app);
  const db = getFirestore(app);

  // DOM элементы
  const form = document.getElementById('dayForm');
  const salaryInfo = document.getElementById('salaryInfo');
  const mediaInput = document.getElementById('media');
  const filePreview = document.getElementById('filePreview');
  const newDayForm = document.getElementById('newDayForm');
  const daysList = document.getElementById('daysList');
  const daysContainer = document.getElementById('daysContainer');
  const pageTitle = document.getElementById('pageTitle');
  const allDaysBtn = document.getElementById('allDaysBtn');
  const newDayBtn = document.getElementById('newDayBtn');
  const userFilterBtns = document.querySelectorAll('.user_filter_btn');
  const monthSelect = document.getElementById('monthSelect');
  const currentMonthYear = document.getElementById('currentMonthYear');
  const daysWorkedEl = document.getElementById('daysWorked');
  const hoursWorkedEl = document.getElementById('hoursWorked');
  const totalSalaryEl = document.getElementById('totalSalary');
  const contractSalaryEl = document.getElementById('contractSalary');
  const dateInput = document.getElementById('date');

  // Стили для медиа-контента
  const style = document.createElement('style');
  style.textContent = `
    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .media-item {
      position: relative;
      overflow: hidden;
      border-radius: 8px;
      background: #f5f5f5;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .media-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }
    .media-image:hover {
      transform: scale(1.05);
    }
    .media-link {
      padding: 10px;
      color: #00a7e0;
      text-decoration: none;
      font-weight: 500;
    }
    .media-video {
      width: 100%;
      max-height: 200px;
      border-radius: 8px;
    }
  `;
  document.head.appendChild(style);

  // Утилиты
  function pad(n) { return String(n).padStart(2, '0'); }
  
  function fmtDateInput(d) {
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  
  function formatDisplayDate(s) {
    const d = new Date(s);
    return d.toLocaleDateString('ru-RU', {day: 'numeric', month: 'long', year: 'numeric'});
  }

  function initMonthSelect() {
    const months = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                   'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
    const now = new Date();
    
    for(let y = now.getFullYear()-1; y <= now.getFullYear()+1; y++) {
      for(let m = 0; m < 12; m++) {
        const opt = document.createElement('option');
        opt.value = `${y}-${m}`;
        opt.text = `${months[m]} ${y}`;
        if(y === now.getFullYear() && m === now.getMonth()) opt.selected = true;
        monthSelect.append(opt);
      }
    }
    updateCurrentMonthDisplay();
  }
  
  function updateCurrentMonthDisplay() {
    const [y, m] = monthSelect.value.split('-').map(Number);
    currentYear = y;
    currentMonth = m;
    const months = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                   'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
    currentMonthYear.textContent = `${months[m]} ${y}`;
  }

  // Установка сегодняшней даты по умолчанию
  dateInput.value = fmtDateInput(new Date());

  // Расчет зарплаты
  function updateFormSalary() {
    const start = form.start_time.value;
    const end = form.end_time.value;
    
    if(!start || !end) {
      salaryInfo.textContent = 'Зарплата: 0.00 руб.';
      return 0;
    }
    
    const startDate = new Date(`1970-01-01T${start}:00`);
    const endDate = new Date(`1970-01-01T${end}:00`);
    let hours = (endDate - startDate) / (1000 * 3600);
    if(hours < 0) hours = 0;
    
    const salary = (hours * 8.4 - 8.4).toFixed(2);
    salaryInfo.textContent = `Зарплата: ${salary} руб.`;
    return parseFloat(salary);
  }

  form.start_time.addEventListener('change', updateFormSalary);
  form.end_time.addEventListener('change', updateFormSalary);

  // Превью загружаемых файлов
  mediaInput.addEventListener('change', () => {
    filePreview.innerHTML = '';
    if(mediaInput.files.length) {
      filePreview.classList.add('active');
      Array.from(mediaInput.files).forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file_item';
        fileItem.innerHTML = `
          <span class="file_icon">📎</span>
          <span class="file_name">${file.name}</span>
        `;
        filePreview.append(fileItem);
      });
    } else {
      filePreview.classList.remove('active');
    }
  });

  // Загрузка файлов на ImgBB
  async function uploadFileToImgBB(file) {
    const formData = new FormData();
    formData.append('image', file);
    
    try {
      const response = await fetch('https://api.imgbb.com/1/upload?key=f615d978ca8fd405d2e746aefcba1637', {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      
      if(data.status !== 200) {
        throw new Error(data.error?.message || 'Ошибка загрузки файла');
      }
      
      return data.data.url;
    } catch (error) {
      console.error('Ошибка загрузки файла:', error);
      throw error;
    }
  }

  // Обработка отправки формы
  form.addEventListener('submit', async e => {
    e.preventDefault();

    const user = form.querySelector('input[name="user"]:checked').value;
    const date = form.date.value;
    const startTime = form.start_time.value;
    const endTime = form.end_time.value;
    const comment = form.comment.value;
    const salary = updateFormSalary();

    try {
      // Загрузка файлов
      let mediaLinks = [];
      if(mediaInput.files.length > 0) {
        for(const file of mediaInput.files) {
          const link = await uploadFileToImgBB(file);
          mediaLinks.push(link);
        }
      }

      // Сохранение данных в Firestore
      await addDoc(collection(db, 'workingDays'), {
        user,
        date,
        startTime,
        endTime,
        comment,
        salary,
        mediaFiles: mediaLinks,
        timestamp: serverTimestamp()
      });

      alert('День успешно сохранен!');
      form.reset();
      filePreview.innerHTML = '';
      filePreview.classList.remove('active');
      salaryInfo.textContent = 'Зарплата: 0.00 руб.';
      dateInput.value = fmtDateInput(new Date());
    } catch (error) {
      alert('Ошибка при сохранении: ' + error.message);
    }
  });

  // Определение типа медиа по URL
  function getMediaType(url) {
    if(/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(url)) return 'image';
    if(/\.(mp4|webm|ogg|mov)$/i.test(url)) return 'video';
    return 'other';
  }

  // Загрузка и отображение дней
  async function loadDays() {
    daysContainer.innerHTML = '<p>Загрузка...</p>';
    
    const startDate = fmtDateInput(new Date(currentYear, currentMonth, 1));
    const endDate = fmtDateInput(new Date(currentYear, currentMonth + 1, 0));
    
    const q = query(
      collection(db, 'workingDays'),
      where('date', '>=', startDate),
      where('date', '<=', endDate)
    );
    
    const snapshot = await getDocs(q);
    const days = [];
    snapshot.forEach(doc => days.push({ id: doc.id, ...doc.data() }));
    
    // Фильтрация по пользователю
    const filteredDays = currentUser === 'all' 
      ? days 
      : days.filter(day => day.user === currentUser);
    
    if(filteredDays.length === 0) {
      daysContainer.innerHTML = '<p>Нет данных за этот период</p>';
      updateStats([]);
      return;
    }
    
    // Сортировка по дате (новые сверху)
    filteredDays.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    daysContainer.innerHTML = '';
    
    filteredDays.forEach(day => {
      let mediaHTML = '';
      if(day.mediaFiles?.length > 0) {
        mediaHTML = `
          <div class="day_media">
            <p>Прикрепленные файлы:</p>
            <div class="media-grid">
              ${day.mediaFiles.map(url => {
                const type = getMediaType(url);
                
                if(type === 'image') {
                  return `
                    <div class="media-item">
                      <img src="${url}" alt="Фото рабочего дня" class="media-image" loading="lazy">
                    </div>
                  `;
                } else if(type === 'video') {
                  return `
                    <div class="media-item">
                      <video controls class="media-video">
                        <source src="${url}" type="video/mp4">
                        Ваш браузер не поддерживает видео.
                      </video>
                    </div>
                  `;
                } else {
                  return `
                    <div class="media-item">
                      <a href="${url}" target="_blank" class="media-link">📁 Скачать файл</a>
                    </div>
                  `;
                }
              }).join('')}
            </div>
          </div>
        `;
      }
      
      const dayCard = document.createElement('div');
      dayCard.className = 'day_card';
      dayCard.innerHTML = `
        <div class="day_header">
          <span>${day.user}</span>
          <span>${formatDisplayDate(day.date)}</span>
        </div>
        <div class="day_time">
          Время работы: ${day.startTime} - ${day.endTime}
        </div>
        <div class="day_comment">
          ${day.comment || 'Нет комментария'}
        </div>
        ${mediaHTML}
        <div class="salary_info">
          Зарплата: ${day.salary || '0.00'} руб.
        </div>
        <button class="delete_btn" data-id="${day.id}">Удалить</button>
      `;
      
      daysContainer.appendChild(dayCard);
    });
    
    // Обработчики для кнопок удаления
    document.querySelectorAll('.delete_btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if(confirm('Вы уверены, что хотите удалить этот день?')) {
          try {
            await deleteDoc(doc(db, 'workingDays', btn.dataset.id));
            btn.parentElement.remove();
            updateStats();
          } catch (error) {
            alert('Ошибка при удалении: ' + error.message);
          }
        }
      });
    });
    
    updateStats(filteredDays);
  }

  // Обновление статистики
  function updateStats(days = []) {
    let totalHours = 0;
    let totalSalary = 0;
    
    days.forEach(day => {
      const start = new Date(`1970-01-01T${day.startTime}:00`);
      const end = new Date(`1970-01-01T${day.endTime}:00`);
      let hours = (end - start) / (1000 * 3600);
      if(hours < 0) hours = 0;
      
      totalHours += hours;
      totalSalary += parseFloat(day.salary || 0);
    });
    
    daysWorkedEl.textContent = days.length;
    hoursWorkedEl.textContent = totalHours.toFixed(1);
    totalSalaryEl.textContent = `${totalSalary.toFixed(2)} руб.`;
    contractSalaryEl.textContent = `${(totalSalary / 0.87).toFixed(2)} руб.`;
  }

  // Текущий пользователь и месяц
  let currentUser = 'all';
  let currentYear = new Date().getFullYear();
  let currentMonth = new Date().getMonth();

  // Обработчики событий
  allDaysBtn.addEventListener('click', e => {
    e.preventDefault();
    newDayForm.style.display = 'none';
    daysList.style.display = 'block';
    pageTitle.textContent = 'Все рабочие дни';
    updateActiveNavBtn(allDaysBtn);
    loadDays();
  });

  newDayBtn.addEventListener('click', e => {
    e.preventDefault();
    newDayForm.style.display = 'block';
    daysList.style.display = 'none';
    pageTitle.textContent = 'Добавить рабочий день';
    updateActiveNavBtn(newDayBtn);
  });

  function updateActiveNavBtn(activeBtn) {
    document.querySelectorAll('.nav_btn').forEach(btn => {
      btn.classList.remove('active');
    });
    activeBtn.classList.add('active');
  }

  userFilterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      userFilterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentUser = btn.dataset.user;
      loadDays();
    });
  });

  monthSelect.addEventListener('change', () => {
    updateCurrentMonthDisplay();
    loadDays();
  });

  // Инициализация
  initMonthSelect();
  loadDays();
</script>


</body>
</html>
