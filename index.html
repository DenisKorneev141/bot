<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–∞–Ω—Ç–∞ | –†–∞–±–æ—á–∏–µ –¥–Ω–∏</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background-color: #00a7e0;
      font-family: 'Roboto', Tahoma, sans-serif;
      color: white;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 480px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 25px;
    }
    .header h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 30px;
    }
    .nav_buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
      gap: 10px;
    }
    .nav_btn {
      flex: 1;
      background-color: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      text-decoration: none;
    }
    .nav_btn:hover {
      background-color: rgba(255,255,255,0.3);
    }
    .nav_btn.active {
      background-color: white;
      color: #00a7e0;
    }
    .form_card {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      color: #333;
    }
    .input_group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      color: #555;
      margin-bottom: 8px;
      font-weight: 500;
    }
    input, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
      color: #333;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    .time_inputs {
      display: flex;
      gap: 10px;
    }
    .time_inputs input {
      flex: 1;
    }
    .radio_group {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      color: #333;
    }
    .radio_option {
      display: flex;
      align-items: center;
    }
    .radio_option input {
      width: auto;
      margin-right: 8px;
    }
    .file_upload {
      margin: 25px 0;
      position: relative;
    }
    .upload_btn {
      display: block;
      background-color: #f0f0f0;
      color: #555;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      font-size: 16px;
      transition: all 0.3s;
      border: 2px dashed #ccc;
    }
    .upload_btn:hover {
      background-color: #e0e0e0;
      border-color: #aaa;
    }
    .file_input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      cursor: pointer;
    }
    .file_preview {
      margin-top: 15px;
      display: none;
    }
    .file_preview.active {
      display: block;
    }
    .file_item {
      display: flex;
      align-items: center;
      background-color: #f8f8f8;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      color: #333;
    }
    .file_icon {
      margin-right: 10px;
      color: #00a7e0;
      font-size: 20px;
      line-height: 1;
    }
    .file_name {
      flex: 1;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .salary_info {
      margin-bottom: 20px;
      font-weight: 600;
      color: #333;
      font-size: 16px;
      text-align: right;
    }
    .submit_btn {
      background-color: #00a7e0;
      color: white;
      border: none;
      padding: 16px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 500;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .submit_btn:hover {
      background-color: #0088c0;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –¥–Ω–µ–π */
    .days_list {
      display: none;
    }
    .day_card {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      color: #333;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .day_header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-weight: 500;
    }
    .day_time {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .day_comment {
      margin-bottom: 15px;
      white-space: pre-wrap;
    }
    .day_media {
      margin-top: 15px;
    }
    .media_item {
      display: inline-block;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .delete_btn {
      background-color: #ff4444;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      margin-top: 15px;
    }
    .user_filter {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    .user_filter_btn {
      background-color: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
    }
    .user_filter_btn.active {
      background-color: white;
      color: #00a7e0;
    }
    
    @media (max-width: 480px) {
      body {
        padding: 15px;
      }
      .header h1 {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1 id="pageTitle">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å</h1>
  </div>
  
  <div class="nav_buttons">
    <a href="#" class="nav_btn" id="allDaysBtn">–í—Å–µ –¥–Ω–∏</a>
    <a href="#" class="nav_btn active" id="newDayBtn">–ù–æ–≤—ã–π –¥–µ–Ω—å</a>
    <a href="#" class="nav_btn" id="settingsBtn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
  </div>
  
  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –¥–Ω—è -->
  <div class="form_card" id="newDayForm">
    <form id="dayForm">
      <div class="radio_group">
        <div class="radio_option">
          <input type="radio" id="denis" name="user" value="–î–µ–Ω–∏—Å" checked />
          <label for="denis">–î–µ–Ω–∏—Å</label>
        </div>
        <div class="radio_option">
          <input type="radio" id="polina" name="user" value="–ü–æ–ª–∏–Ω–∞" />
          <label for="polina">–ü–æ–ª–∏–Ω–∞</label>
        </div>
      </div>
      <div class="input_group">
        <label for="date">–î–∞—Ç–∞</label>
        <input type="date" id="date" required />
      </div>
      <div class="input_group">
        <label>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</label>
        <div class="time_inputs">
          <input type="time" id="start_time" value="08:00" required />
          <input type="time" id="end_time" value="20:00" required />
        </div>
      </div>
      <div class="input_group">
        <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–æ –¥–Ω—é</label>
        <textarea id="comment" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à –¥–µ–Ω—å..."></textarea>
      </div>
      <div class="file_upload">
        <label class="upload_btn" for="media">+ –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ</label>
        <input type="file" id="media" class="file_input" accept="image/*,video/*" multiple />
        <div class="file_preview" id="filePreview"></div>
      </div>
      <div class="salary_info" id="salaryInfo">–ó–∞—Ä–ø–ª–∞—Ç–∞: 0.00 —Ä—É–±.</div>
      <button type="submit" class="submit_btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
  </div>
  
  <!-- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–Ω–µ–π -->
  <div class="days_list" id="daysList">
    <div class="user_filter">
      <button class="user_filter_btn active" data-user="all">–í—Å–µ</button>
      <button class="user_filter_btn" data-user="–î–µ–Ω–∏—Å">–î–µ–Ω–∏—Å</button>
      <button class="user_filter_btn" data-user="–ü–æ–ª–∏–Ω–∞">–ü–æ–ª–∏–Ω–∞</button>
    </div>
    <div id="daysContainer">
      <!-- –î–Ω–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js";
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    getDocs,
    deleteDoc,
    doc,
    query,
    where,
    serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCd2Y3GhHKtibLrqipERwf5vMrCSNLFl60",
    authDomain: "santa-diary.firebaseapp.com",
    projectId: "santa-diary",
    storageBucket: "santa-diary.appspot.com",
    messagingSenderId: "193506574944",
    appId: "1:193506574944:web:23e0282d5129f2f793c7a7",
    measurementId: "G-GTPJ66CWH0"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);

  // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
  const form = document.getElementById('dayForm');
  const salaryInfo = document.getElementById('salaryInfo');
  const mediaInput = document.getElementById('media');
  const filePreview = document.getElementById('filePreview');
  const newDayForm = document.getElementById('newDayForm');
  const daysList = document.getElementById('daysList');
  const daysContainer = document.getElementById('daysContainer');
  const pageTitle = document.getElementById('pageTitle');
  const allDaysBtn = document.getElementById('allDaysBtn');
  const newDayBtn = document.getElementById('newDayBtn');
  const userFilterBtns = document.querySelectorAll('.user_filter_btn');

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
  allDaysBtn.addEventListener('click', (e) => {
    e.preventDefault();
    newDayForm.style.display = 'none';
    daysList.style.display = 'block';
    pageTitle.textContent = '–í—Å–µ —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏';
    updateActiveNavBtn(allDaysBtn);
    loadDays();
  });

  newDayBtn.addEventListener('click', (e) => {
    e.preventDefault();
    newDayForm.style.display = 'block';
    daysList.style.display = 'none';
    pageTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å';
    updateActiveNavBtn(newDayBtn);
  });

  function updateActiveNavBtn(activeBtn) {
    document.querySelectorAll('.nav_btn').forEach(btn => {
      btn.classList.remove('active');
    });
    activeBtn.classList.add('active');
  }

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
  const dateInput = document.getElementById('date');
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  dateInput.value = `${yyyy}-${mm}-${dd}`;

  // –†–∞—Å—á–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã
  function updateSalary() {
    const start = form.querySelector('#start_time').value;
    const end = form.querySelector('#end_time').value;
    if (start && end) {
      const startDate = new Date(`1970-01-01T${start}:00`);
      const endDate = new Date(`1970-01-01T${end}:00`);
      let diff = (endDate - startDate) / (1000 * 60 * 60);
      if (diff < 0) diff = 0;
      const salary = (diff * 8.4 - 8.4).toFixed(2);
      salaryInfo.textContent = `–ó–∞—Ä–ø–ª–∞—Ç–∞: ${salary} —Ä—É–±.`;
      return parseFloat(salary);
    }
    salaryInfo.textContent = `–ó–∞—Ä–ø–ª–∞—Ç–∞: 0.00 —Ä—É–±.`;
    return 0;
  }

  form.querySelector('#start_time').addEventListener('change', updateSalary);
  form.querySelector('#end_time').addEventListener('change', updateSalary);

  // –ü—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
  mediaInput.addEventListener('change', () => {
    filePreview.innerHTML = '';
    if (mediaInput.files.length > 0) {
      filePreview.classList.add('active');
      Array.from(mediaInput.files).forEach(file => {
        const div = document.createElement('div');
        div.className = 'file_item';
        div.innerHTML = `<span class="file_icon">üìé</span><span class="file_name">${file.name}</span>`;
        filePreview.appendChild(div);
      });
    } else {
      filePreview.classList.remove('active');
    }
  });

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const user = form.querySelector('input[name="user"]:checked').value;
    const date = form.querySelector('#date').value;
    const startTime = form.querySelector('#start_time').value;
    const endTime = form.querySelector('#end_time').value;
    const comment = form.querySelector('#comment').value;
    const salary = updateSalary();

    const files = mediaInput.files;
    let mediaFiles = [];
    if (files.length > 0) {
      for (const f of files) {
        mediaFiles.push(f.name);
      }
    }

    try {
      await addDoc(collection(db, "workingDays"), {
        user: user,
        date: date,
        startTime: startTime,
        endTime: endTime,
        comment: comment,
        salary: salary,
        mediaFiles: mediaFiles,
        timestamp: serverTimestamp()
      });
      alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
      form.reset();
      filePreview.innerHTML = '';
      filePreview.classList.remove('active');
      salaryInfo.textContent = `–ó–∞—Ä–ø–ª–∞—Ç–∞: 0.00 —Ä—É–±.`;
      dateInput.value = `${yyyy}-${mm}-${dd}`;
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
    }
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–Ω–µ–π
  async function loadDays(user = 'all') {
    daysContainer.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    
    let q;
    if (user === 'all') {
      q = query(collection(db, "workingDays"));
    } else {
      q = query(collection(db, "workingDays"), where("user", "==", user));
    }
    
    const querySnapshot = await getDocs(q);
    
    if (querySnapshot.empty) {
      daysContainer.innerHTML = '<p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–Ω–µ–π</p>';
      return;
    }
    
    daysContainer.innerHTML = '';
    
    const days = [];
    querySnapshot.forEach((docSnapshot) => {
      days.push({
        id: docSnapshot.id,
        ...docSnapshot.data()
      });
    });
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
    days.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    days.forEach(day => {
      const dayCard = document.createElement('div');
      dayCard.className = 'day_card';
      dayCard.dataset.user = day.user;
      
      let mediaHTML = '';
      if (day.mediaFiles && day.mediaFiles.length > 0) {
        mediaHTML = `
          <div class="day_media">
            <p>–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:</p>
            ${day.mediaFiles.map(file => 
              `<div class="media_item">üìé ${file}</div>`
            ).join('')}
          </div>
        `;
      }
      
      dayCard.innerHTML = `
        <div class="day_header">
          <span>${day.user}</span>
          <span>${formatDate(day.date)}</span>
        </div>
        <div class="day_time">
          –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: ${day.startTime} - ${day.endTime}
        </div>
        <div class="day_comment">
          ${day.comment || '–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}
        </div>
        ${mediaHTML}
        <div class="salary_info">
          –ó–∞—Ä–ø–ª–∞—Ç–∞: ${day.salary || '0.00'} —Ä—É–±.
        </div>
        <button class="delete_btn" data-id="${day.id}">–£–¥–∞–ª–∏—Ç—å</button>
      `;
      
      daysContainer.appendChild(dayCard);
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
    document.querySelectorAll('.delete_btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å?')) {
          try {
            await deleteDoc(doc(db, "workingDays", btn.dataset.id));
            btn.parentElement.remove();
          } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
          }
        }
      });
    });
  }

  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', {
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });
  }

  // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  userFilterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      userFilterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      loadDays(btn.dataset.user);
    });
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  updateSalary();
</script>
</body>
</html>
